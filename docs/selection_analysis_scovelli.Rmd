---
title: "Selection pressures in _Syngnathus scovelli_"
output: 
  github_document:
    toc: true
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='../',
                     fig_path="../figs/")
```

``` {r library, message = FALSE, warning = FALSE}
#This is a cohesive list of all the libraries used in this document
library(ggplot2)
library(cowplot)
library(fBasics)
library(pwr)
library(lme4)
library(dplyr)
library(tidyr)
library(knitr)

```

``` {r read-data, message = FALSE, warning = FALSE}

#Metadata for males and females from the mesocosm experiments
fem_mesoSS <- read.csv("data/all_fem_meso_scovelli.csv")
mal_mesoSS <- read.csv("data/all_mal_meso_scovelli.csv")

```

This document will follow the same analysis as was outlined in `selection_analysis_floridae.Rmd`. For more thorough details refer back to that document. 

The datasets used in this document were pulled from a publically accessible manuscript that ran similar experimental breeding populations (Rose et al., 2013).

# Cleaning the datasets
For the male dataset I want to do a few things before using it: 
  1. Remove the two males that died (C1M5 and C6M2).
  2. Replace all of the "NAs" present in the males who didn't mate with 0's when appropriate.
  3. Add a column of mating success to the dataset. This will be either a 0 or 1 as _S. scovelli_ males only mate once.

In the female dataset I am going to remove C1F2 since she doesn't have any data related to her reproductive success.

For both the male and the female datasets I also want to subset them out to only include the control fish and not fish that were exposed to estrogen.

```{r clean-datasets}
#Subset the datasets to remove the fish exposed to estrogen
fem_succSS <- fem_mesoSS[grep("C", fem_mesoSS$trial_num),]
mal_succSS <- mal_mesoSS[grep("C", fem_mesoSS$trial_num),]

#Adding full fishIDs to make removing individuals easier
fem_succSS$femID <- paste0(fem_succSS$trial_num, "F",
                         fem_succSS$fishID)
mal_succSS$maleID <- paste0(mal_succSS$trial_num, "M",
                          mal_succSS$fishID)
#Removing the one female
fem_succSS <- subset(fem_succSS, !(femID %in% "C1F2"))

#Removing the two males who died
mal_succSS <- subset(mal_succSS, !(maleID %in% c("C1M5", "C6M2")))

#Replace NAs with 0s in the columns related to fitness
mal_succSS[, c("NumDeveloped", 
               "NumUndeveloped",
               "totalEggs")] <- sapply(mal_succSS[, c("NumDeveloped",
                                                      "NumUndeveloped",
                                                      "totalEggs")],
                                       function(x)
                                         as.numeric(ifelse(is.na(x), 0, x)))

#Add a column for females and males to denote mating success
mal_succSS$MatingSuccess <- ifelse(mal_succSS$totalEggs > 0, 
                                   1, 
                                   0)

fem_succSS$mated <- ifelse(fem_succSS$MatingSuccess > 0,
                           1,
                           0)

```

# Calculating the degree of sexual dimorphism
The original datasets contained only information about standard length. To allow for a more complete comparison between all three species within the genus _Syngnathus_ I obtained the original photographs of those pipefish and re-measured them to obtain measurements of both torso depth and snout-vent length for males and females.

Now, we can see if males and females differ in standard length, torso depth, and snout-vent length. First, I need to see if assumptions are met, i.e. variances are equal and data is normally distributed.

## Checking the assumptions for a pairwise comparison
 The main two things that I will be looking into include:

1. Equal variances between groups (using `var.test()`).
2. Normal distribution of the data (using `normalTest()`).

To account for the fact that fish who are longer may just inherently be deeper as well, I am going to adjust the depth by the standard length of the pipefish prior to running any analyses. This length-adjusted depth will then be used in all consequent analyses.

```{r sd-assumption-test}

#Adjust the torso depth
fem_succSS$depth_adj <- fem_succSS$depth/fem_succSS$length
mal_succSS$depth_adj <- mal_succSS$depth/mal_succSS$length

#Testing to see if the variances are equal
var.test(fem_succSS$length, mal_succSS$length) #not equal
var.test(fem_succSS$depth_adj, mal_succSS$depth_adj)
var.test(fem_succSS$svl, mal_succSS$svl)

#Testing for normal distribution
normalTest(fem_succSS$length, method = "da") #not normal
normalTest(mal_succSS$length, method = "da") #normal
normalTest(fem_succSS$depth_adj, method = "da") #normal
normalTest(mal_succSS$depth_adj, method = "da")
normalTest(fem_succSS$svl, method = "da") #not normal
normalTest(mal_succSS$svl, method = "da")

```

## Investigate distributions and run the tests
I will run a Welch's two sample t-test test for standard length...

```{r histogram_sizes, message=FALSE, warning = FALSE, echo = FALSE, fig.cap="_Histograms of male and female pipefish body sizes._", fig.width=15}

#Combining the datasets
fem_succSS$Sex <- "F"
mal_succSS$Sex <- "M"
all_sex_meso <- rbind(fem_succSS[, c("length", "depth_adj", "svl", "Sex")], mal_succSS[, c("length", "depth_adj", "svl", "Sex")])

length <- ggplot(data = all_sex_meso, aes(x = length)) +
  geom_histogram(aes(fill = Sex),
                 alpha = 0.5,
                 position = 'identity') +
  scale_fill_manual(values = c("#7fc97f75", "#beaed475")) +
  theme_minimal() +
  labs(x = "Length (mm)",
       y = "Number of Pipefish",
       title = "Length of male and female pipefish")

depth <- ggplot(data = all_sex_meso, aes(x = depth_adj)) +
  geom_histogram(aes(fill = Sex),
                 alpha = 0.5,
                 position = 'identity') +
  scale_fill_manual(values = c("#7fc97f75", "#beaed475")) +
  theme_minimal() +
  labs(x = "Depth (mm)",
       y = "Number of Pipefish",
       title = "Depth of male and female pipefish")

svl <- ggplot(data = all_sex_meso, aes(x = svl)) +
  geom_histogram(aes(fill = Sex),
                 alpha = 0.5,
                 position = 'identity') +
  scale_fill_manual(values = c("#7fc97f75", "#beaed475")) +
  theme_minimal() +
  labs(x = "SVL (mm)",
       y = "Number of Pipefish",
       title = "Snout-vent length of male and female pipefish")

plot_grid(length, depth, svl,
          ncol = 3)

```

```{r sd-t-tests}
t.test(fem_succSS$length, mal_succSS$length, 
       var.equal = FALSE) #Sig. difference

```

For the Gulf pipefish, there are significant differences between males and females in terms of standard length, snout-vent length, and torso depth. 

```{r power-test}

#Checking the power - length
d_mean_len <- abs(mean(fem_succSS$length, na.rm = TRUE) - 
                    mean(mal_succSS$length, na.rm = TRUE))
pool_sd_len <- sqrt((var(fem_succSS$length, na.rm = TRUE) + 
                       var(mal_succSS$length, na.rm = TRUE))/ 2)
d_len <- d_mean_len/pool_sd_len

pwr.t.test(n = nrow(fem_succSS), 
           d = d_len,
           sig.level = 0.05,
           type = 'two.sample',
           alternative = 'two.sided')

#Checking the power - SVL
d_mean_svl <- abs(mean(fem_succSS$svl, na.rm = TRUE) - 
                    mean(mal_succSS$svl, na.rm = TRUE))
pool_sd_svl <- sqrt((var(fem_succSS$svl, na.rm = TRUE) + 
                       var(mal_succSS$svl, na.rm = TRUE))/ 2)
d_svl <- d_mean_svl/pool_sd_svl

pwr.t.test(n = nrow(fem_succSS), 
           d = d_svl,
           sig.level = 0.05,
           type = 'two.sample',
           alternative = 'two.sided')

#Checking the power - Depth
d_mean_depth <- abs(mean(fem_succSS$depth_adj, na.rm = TRUE) - 
                      mean(mal_succSS$depth_adj, na.rm = TRUE))
pool_sd_depth <- sqrt((var(fem_succSS$depth_adj, na.rm = TRUE) + 
                         var(mal_succSS$depth_adj, na.rm = TRUE))/ 2)
d_depth <- d_mean_depth/pool_sd_depth
pwr.t.test(n = nrow(fem_succSS), 
           d = d_depth,
           sig.level = 0.05,
           type = 'two.sample',
           alternative = 'two.sided')

```

For all variables we have a power of over 0.9 or over 90% so we can be confident in our interpretation.

# Summary statistics for successfully mated individuals
## Males
Across all `r length(unique(mal_succSS$trial_num))` trials and `r nrow(mal_succSS)` total males, there were `r nrow(mal_succSS[mal_succSS$MatingSuccess == 1,])` males that mated at least one time and `r nrow(mal_succSS[mal_succSS$MatingSuccess > 1,])` of those males had two mates. 

Looking across all males, including the ones that did not mate, this is what we find as the mean, sd, and se for the number of embryos transferred and how many of those developed versus didn't:

|                  | mean| SD| SE| max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(mal_succSS$totalEggs)`|`r sd(mal_succSS$totalEggs)`|  `r sd(mal_succSS$totalEggs)/sqrt(nrow(mal_succSS))`|`r max(mal_succSS$totalEggs)` | `r min(mal_succSS$totalEggs)`|
|Developed Embryos | `r mean(mal_succSS$NumDeveloped)`|`r sd(mal_succSS$NumDeveloped)`|  `r sd(mal_succSS$NumDeveloped)/sqrt(nrow(mal_succSS))`|`r max(mal_succSS$NumDeveloped)` | `r min(mal_succSS$NumDeveloped)`|
|Undeveloped Embryos| `r mean(mal_succSS$NumUndeveloped)`|`r sd(mal_succSS$NumUndeveloped)`|  `r sd(mal_succSS$NumUndeveloped)/sqrt(nrow(mal_succSS))`|`r max(mal_succSS$NumUndeveloped)` | `r min(mal_succSS$NumUndeveloped)`|

These values will be influenced by the number of 0s coming from males who did not mate. So let's look at the same thing, but this time for only males who had at least one successful mating:

|                  | mean| SD| SE|  max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(mal_succSS$totalEggs[mal_succSS$MatingSuccess == 1])`|`r sd(mal_succSS$totalEggs[mal_succSS$MatingSuccess == 1])`|  `r sd(mal_succSS$totalEggs[mal_succSS$MatingSuccess == 1])/sqrt(nrow(mal_succSS[mal_succSS$MatingSuccess == 1,]))`| `r max(mal_succSS$totalEggs[mal_succSS$MatingSuccess == 1])` | `r min(mal_succSS$totalEggs[mal_succSS$MatingSuccess == 1])` |
|Developed Embryos | `r mean(mal_succSS$NumDeveloped[mal_succSS$MatingSuccess == 1])`|`r sd(mal_succSS$NumDeveloped[mal_succSS$MatingSuccess == 1])`|  `r sd(mal_succSS$NumDeveloped[mal_succSS$MatingSuccess == 1])/sqrt(nrow(mal_succSS[mal_succSS$MatingSuccess == 1,]))`|`r max(mal_succSS$NumDeveloped[mal_succSS$MatingSuccess == 1])` | `r min(mal_succSS$NumDeveloped[mal_succSS$MatingSuccess == 1])` |
|Undeveloped Embryos| `r mean(mal_succSS$NumUndeveloped[mal_succSS$MatingSuccess == 1])`|`r sd(mal_succSS$NumUndeveloped[mal_succSS$MatingSuccess == 1])`|  `r sd(mal_succSS$NumUndeveloped[mal_succSS$MatingSuccess == 1])/sqrt(nrow(mal_succSS[mal_succSS$MatingSuccess == 1,]))`| `r max(mal_succSS$NumUndeveloped[mal_succSS$MatingSuccess == 1])` | `r min(mal_succSS$NumUndeveloped[mal_succSS$MatingSuccess == 1])` |

I know want to see if there are correlations between morphometrics such as standard length and brood size (i.e., are larger males securing larger broods).

```{r em-v-sl, echo=FALSE, fig.cap="_Scatterplot of the relationship between standard length (mm) and the number of embryos a male had._", fig.width=15, fig.height=10}

#create a subset of only the males who mated
mal_succSS$totalEggs <- as.numeric(mal_succSS$totalEggs)
mated_malSS <- mal_succSS[mal_succSS$MatingSuccess == 1, ]

plot(mated_malSS$length,
     mated_malSS$totalEggs,
     xlab = "Standard Length (mm)",
     ylab = "Brood Size (# embryos)",
     col = "#CD5C5C75",
     pch = 19,
     cex = 1.5
)
abline(lm(mated_malSS$totalEggs ~ as.numeric(mated_malSS$length)), lwd = 3, lty = 2)
```

```{r eggs-sl-cor, echo=FALSE}
cor.test(mated_malSS$length, mated_malSS$totalEggs)
```

There is a significant correlation! Larger males have bigger broods.

## Females
Across all `r length(unique(fem_succSS$trial_num))` trials and `r nrow(fem_succSS)` total females, there were `r nrow(fem_succSS[fem_succSS$MatingSuccess != 0,])` females that mated at least one time, `r nrow(fem_succSS[fem_succSS$MatingSuccess == 2,])` females that mated twice, and `r nrow(fem_succSS[fem_succSS$MatingSuccess == 3,])` that mated 3 times. 

Looking across all females, including the ones that did not mate, this is what we find as the mean, sd, and se for the total number of embryos transferred from each female (across all of her mates if applicable) and how many of those developed versus didn't:

|                  | mean| SD| SE| max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(fem_succSS$totalEggs)`|`r sd(fem_succSS$totalEggs)`|  `r sd(fem_succSS$totalEggs)/sqrt(nrow(fem_succSS))`|`r max(fem_succSS$totalEggs)` | `r min(fem_succSS$totalEggs)`|
|Developed Embryos | `r mean(fem_succSS$NumDeveloped)`|`r sd(fem_succSS$NumDeveloped)`|  `r sd(fem_succSS$NumDeveloped)/sqrt(nrow(fem_succSS))`|`r max(fem_succSS$NumDeveloped)` | `r min(fem_succSS$NumDeveloped)`|
|Undeveloped Embryos| `r mean(fem_succSS$NumUndeveloped)`|`r sd(fem_succSS$NumUndeveloped)`|  `r sd(fem_succSS$NumUndeveloped)/sqrt(nrow(fem_succSS))`|`r max(fem_succSS$NumUndeveloped)` | `r min(fem_succSS$NumUndeveloped)`|

These values will be influenced by the number of 0s coming from females who did not mate. So let's look at the same thing, but this time for only females who had at least one successful mating:

|                  | mean| SD| SE|  max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(fem_succSS$totalEggs[fem_succSS$MatingSuccess != 0])`|`r sd(fem_succSS$totalEggs[fem_succSS$MatingSuccess != 0])`|  `r sd(fem_succSS$totalEggs[fem_succSS$MatingSuccess != 0])/sqrt(nrow(fem_succSS[fem_succSS$MatingSuccess != 0,]))`| `r max(fem_succSS$totalEggs[fem_succSS$MatingSuccess != 0])` | `r min(fem_succSS$totalEggs[fem_succSS$MatingSuccess != 0])` |
|Developed Embryos | `r mean(fem_succSS$NumDeveloped[fem_succSS$MatingSuccess != 0])`|`r sd(fem_succSS$NumDeveloped[fem_succSS$MatingSuccess != 0])`|  `r sd(fem_succSS$NumDeveloped[fem_succSS$MatingSuccess != 0])/sqrt(nrow(fem_succSS[fem_succSS$MatingSuccess != 0,]))`|`r max(fem_succSS$NumDeveloped[fem_succSS$MatingSuccess != 0])` | `r min(fem_succSS$NumDeveloped[fem_succSS$MatingSuccess != 0])` |
|Undeveloped Embryos| `r mean(fem_succSS$NumUndeveloped[fem_succSS$MatingSuccess != 0])`|`r sd(fem_succSS$NumUndeveloped[fem_succSS$MatingSuccess != 0])`|  `r sd(fem_succSS$NumUndeveloped[fem_succSS$MatingSuccess != 0])/sqrt(nrow(fem_succSS[fem_succSS$MatingSuccess != 0,]))`| `r max(fem_succSS$NumUndeveloped[fem_succSS$MatingSuccess != 0])` | `r min(fem_succSS$NumUndeveloped[fem_succSS$MatingSuccess != 0])` |

I want to see what relationship there may be between female body size (in terms of standard length, depth, and SVL) and the number of eggs she transferred. I also want to see on average how many eggs were transferred per mating. I'm going to calculate this by taking the total number of eggs and dividing it by the number of mates. 

```{r egg-per-mate-fem, echo=FALSE}
eggs_per_mate <- fem_succSS$totalEggs/fem_succSS$MatingSuccess
mean(eggs_per_mate, na.rm = TRUE)
sd(eggs_per_mate, na.rm = TRUE)/sqrt(length(eggs_per_mate))
```

```{r em-v-fem-size, echo=FALSE, fig.cap="Scatterplot of the relationship between female size metrics and the number of eggs transferred.", fig.width=15, fig.height=5}
#create a subset of only the females who mated
mated_femSS <- fem_succSS[fem_succSS$MatingSuccess != 0, ]

#Plot total number of eggs transferred against the different metrics for females size
par(mfrow=c(1,3))
plot(mated_femSS$length,
     mated_femSS$totalEggs,
     xlab = "Length (mm)",
     ylab = "Number of eggs transferred",
     col = "darkorange",
     pch = 19)
abline(lm(mated_femSS$totalEggs ~ mated_femSS$length), lwd = 3, lty = 2)
plot(mated_femSS$depth_adj,
     mated_femSS$totalEggs,
     xlab = "Depth (mm)",
     ylab = "Number of eggs transferred",
     col = "cyan4",
     pch = 19)
abline(lm(mated_femSS$totalEggs ~ mated_femSS$depth_adj), lwd = 3, lty = 2)
plot(mated_femSS$svl,
     mated_femSS$totalEggs,
     xlab = "Snout-vent Length (mm)",
     ylab = "Number of eggs transferred",
     col = "purple",
     pch = 19)
abline(lm(mated_femSS$totalEggs ~ mated_femSS$svl), lwd = 3, lty = 2)

```

There also appears to be a correlation between female body size and the number of eggs transferred, especially in terms of depth and snout-vent length. Let's run some correlations tests to see what they say.

```{r eggs-fem-size-cor, echo=FALSE}
cor.test(mated_femSS$length, as.numeric(mated_femSS$totalEggs))
cor.test(mated_femSS$depth_adj, as.numeric(mated_femSS$totalEggs))
cor.test(mated_femSS$svl, as.numeric(mated_femSS$totalEggs))

```

There is no sig. correlation between length or svl and the number of eggs transferred but we do see a significantly positive relationship between depth and number of eggs transferred! It seems to be depth is a good indicator of fecundity for females. 

# Differences between mated individuals and unmated individuals
I want to now see if there are any significant differences in the sizes of individuals who mated vs individuals that didn't mate in males and females. I am going to be focusing on the same morphometrics outlined above.

## Females
Similarly, now let's see if we can identify any significant differences in the morphometrics of females who were able to obtain mates versus those who were unsuccessful.

### Visual Comparison

```{r mat-status-morph-fem, echo=FALSE, fig.cap="_Four different morphometrics compared between females who sucessfully mated versus those that didn't. Orange represents unmated and blue represents mated females._", fig.height=10, fig.width=10}

par(mfrow=c(1,3))
fem_succSS$mated <- as.factor(fem_succSS$mated)

boxplot(fem_succSS$length ~ fem_succSS$mated,
        xlab = "Mated",
        ylab = "Length (mm)",
        col= c("darkorange", "cyan4"))
boxplot(fem_succSS$depth_adj ~ fem_succSS$mated,
        xlab = "Mated",
        ylab = "Depth (mm)",
        col= c("darkorange", "cyan4"))
boxplot(fem_succSS$svl ~ fem_succSS$mated,
        xlab = "Mated",
        ylab = "Snout-vent Length (mm)",
        col= c("darkorange", "cyan4"))

```

For all categories it appears that females are larger in length, depth, and snout-vent length.

### Testing the difference
Let's now put some statistical power behind the difference in various morphometrics between mated and unmated individuals. 

```{r mat-stat-stat-fem, echo=FALSE, warning=FALSE}
#Test the assumptions
##Equal variances
var.test(fem_succSS$length ~ fem_succSS$mated) #equal
var.test(fem_succSS$depth_adj ~ fem_succSS$mated) #equal
var.test(fem_succSS$svl ~ fem_succSS$mated) #equal

##Normal Distributions
normalTest(fem_succSS$length, method = "da") #not normal
normalTest(fem_succSS$depth_adj, method = "da") #normal
normalTest(fem_succSS$svl, method = "da") #not normal

#Running the appropriate test
wilcox.test(fem_succSS$length ~ fem_succSS$mated) #sig.
t.test(fem_succSS$depth_adj ~ fem_succSS$mated, 
       var.equal = TRUE) #sig.
wilcox.test(fem_succSS$svl ~ fem_succSS$mated) #sig.

```

Females who mated are significantly larger in terms of standard length, torso depth, and snout-vent length.

Let's explore this a bit more and overlay the distribution of sizes in all females (mated and unmated) with the sizes of females who did mate and see how it varies.

```{r mated-unmated-hist-depth, echo=FALSE, fig.cap= "_Overlay of the standard length, torso depth, and snout-vent length of females who mated on top of the size range of all females._", fig.width= 15, fig.height= 10}

par(mfrow = c(1,3))
hist(fem_succSS$length, 
     xlab = "Standard Length (mm)", 
     ylab = "Number of female pipefish",
     col = "#7fc97f", breaks = 15, main = "")

hist(fem_succSS$length[fem_succSS$MatingSuccess != 0], 
     add = TRUE,
     col = "#548B54", breaks = 15)

hist(fem_succSS$depth_adj, 
     xlab = "Torso Depth (mm)", 
     ylab = "Number of female pipefish",
     col = "#7fc97f", breaks = 12, main = "")

hist(fem_succSS$depth_adj[fem_succSS$MatingSuccess != 0], 
     add = TRUE,
     col = "#548B54", breaks = 12)

hist(fem_succSS$svl, 
     xlab = "Snout-vent Length (mm)", 
     ylab = "Number of female pipefish",
     col = "#7fc97f", breaks = 20, main = "")

hist(fem_succSS$svl[fem_succSS$MatingSuccess != 0], 
     add = TRUE,
     col = "#548B54", breaks = 15)

legend("topright",
       legend = c("Mated Females", "All Females"),
       col = c("#548B54", "#7fc97f"),
       pch = 15)
```

There is still quite a spread in the sizes of females who mated, but in every case the female with the largest value secured a mate.

# Looking into the Opportunity for Selection in Males and Females
One of the benefits of using genetic parentage analysis is that we can now calculate the opportunity for selection and the opportunity for sexual selection in male and female pipefish. 

## Generating the total opportunity for selection ($I$) and the opportunity for sexual selection ($I_S$)
Because each trial provides an independent "population" (i.e., pipefish from one trial **cannot mate** with pipefish from another trial), I am going to calculate these metrics for each trial individually and then I will average it. With these I can then also generate 95% confidence intervals which I will investigate for indications of significance in two ways:

  - If the confidence intervals **DO NOT** cross 0 -> significant selection.
  - If the confidence intervals between the sexes **DO NOT** cross -> significantly different selection between the two sexes.

```{r opp-selection}
##FEMALES
#Create a dataframe to store the calculations of I and I_S in
fem_opp_selection <- data.frame(matrix(ncol = 3,
                                       nrow = 0))

colnames(fem_opp_selection) <- c("trial_num", "I", "I_s")

#Loop through the different trials and calculate I and I_S
for (trial in unique(fem_succSS$trial_num)) {
  
  #Subset the overall dataframe to work with an individual trial
  tmp <- fem_succSS[fem_succSS$trial_num == trial, ]
  
  #Calculate opportunity selection
  I <- var(tmp$NumDeveloped)/(mean(tmp$NumDeveloped)^2)
  
  I_s <- var(tmp$MatingSuccess)/(mean(tmp$MatingSuccess)^2)
  
  #Combining all of the selection values (Is) and save the output
  trial_num <- as.numeric(gsub("^(C)(\\d)", "\\2",
                               trial))
  selection <- cbind(trial_num, I, I_s)
  
  fem_opp_selection <- rbind(fem_opp_selection, selection)
  
}


##MALES
#Create a dataframe to store the calculations of I and I_S in
mal_opp_selection <- data.frame(matrix(ncol = 3,
                                       nrow = 0))

colnames(mal_opp_selection) <- c("trial_num", "I", "I_s")

#Loop through the different trials and calculate I and I_S
for (trial in unique(mal_succSS$trial_num)) {
  
  #Subset the overall dataframe to work with an individual trial
  tmp <- mal_succSS[mal_succSS$trial_num == trial, ]
  
  #Calculate opportunity selection
  I <- var(tmp$NumDeveloped)/(mean(tmp$NumDeveloped)^2)
  
  I_s <- var(tmp$MatingSuccess)/(mean(tmp$MatingSuccess)^2)
  
  #Combining all of the selection values (Is) and save the output
  trial_num <- as.numeric(gsub("^(C)(\\d)", "\\2",
                               trial))
  selection <- cbind(trial_num, I, I_s)
  
  mal_opp_selection <- rbind(mal_opp_selection, selection)
  
}

#Merge the selection coefficients from males and females into one dataset to 
#make life easier
fem_opp_selection$Sex <- "F"
mal_opp_selection$Sex <- "M"

opp_selection_all <- rbind(fem_opp_selection, mal_opp_selection)
```

Now that I have calculated the opportunity for selection and sexual selection, I want to generate my averages and 95% CI for both.

```{r opp-selection-CI}
#List the columns of interest
columns <- c("I", "I_s")

#Create a dataframe to store the final values in
opp_average <- data.frame(matrix(ncol = 4,
                                 nrow = 0))
colnames(opp_average) <- c("Average", "Interval", "Episode_sel", "Sex")

#Calculate the critical value
crit <- qt(p = 0.975, df = (nrow(fem_opp_selection) - 1))

for (j in 1:length(columns)) {
    
    col_name <- columns[[j]]
    
    #Calculate the means
    mean <- t(t(tapply(opp_selection_all[, colnames(opp_selection_all) == col_name], 
                       opp_selection_all$Sex, 
                       mean)))
    
    #Calculate standard error
    se <- t(t(tapply(opp_selection_all[, colnames(opp_selection_all) == col_name], 
                     opp_selection_all$Sex, 
                 function(x){
                   sqrt(var(x))/sqrt(length(x))
                 })))
    
    #Calculate the value that is added and subtracted from the mean
    int <- se*crit
    
    #Combine the data together
    episode <- as.data.frame(cbind(mean, int))
    colnames(episode) <- c("Average", "Interval")
    
    episode$Episode_sel <- col_name
    episode$Sex <- rownames(episode)
    
    rownames(episode) <- NULL
    
    opp_average <- rbind(opp_average, episode)
    
  }

```

Let's now explore some results:

```{r opp-selection-table, echo = FALSE, warning=FALSE}

#Create a new column
opp_average <- opp_average %>%
  mutate(Combined = paste0(round(Average , 2), 
                           " (", round(Average - Interval, 2), ", ",
                           round(Average + Interval, 2), ")"))

#Transform data into wide format
sum_opp <- opp_average %>% 
  select(Episode_sel, Sex, Combined) %>% 
  pivot_wider(names_from = Sex, values_from = Combined) 

#Display the table
kable(sum_opp, caption = "Average Opportunity of Selection (95% CI) for Males and Females")

```


```{r opp-selection-figure, echo=FALSE, fig.cap="_Average opportunity for selection and opportunity for sexual selection for male (purple) and female (green) S. scovelli. Errorbars represent the 95% confidence intervals around the mean_", fig.width=8, fig.height=6, warning=FALSE}

#Set parameters
sex_cols <- c("F" = "#7fc97f", "M" = "#beaed4" )
pd <- position_dodge(1)

ggplot(opp_average,
       aes(x = Episode_sel,
           y = Average,
           color = Sex,
           group = Sex)) +
  geom_errorbar(aes(ymin = Average - Interval,
                    ymax = Average + Interval),
                color = "black",
                width = 0.2,
                position = pd,
                linewidth = 1) +
  geom_point(position = pd,
             size = 4) +
  xlab("Episode of Selection") +
  ylab("Average Fitness Value") +
  scale_color_manual(values = sex_cols) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  theme(legend.position = "bottom",
        legend.key=element_blank(),
        axis.title.x = element_text(size = 16,
                                    vjust = -0.5),
        axis.text.x = element_text(size = 16, family = "serif"),
        axis.title.y = element_text(size = 16,
                                    vjust = 2.5),
        axis.text.y = element_text(size = 16),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12)) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1)

```

We can see that for female _S. scovelli_ there is a significant opportunity for selection and opportunity for sexual selection, however, males only experience a significant opportunity for selection, but not sexual selection. Additionally, we can see a significant difference in the opportunity for sexual selection between males and females.

## Partitioning the Total Opportunity for Selection ($I$)
Once again for partitioning the opportunity for selection, I am going to calculate selection for the trials individually in males and females and then average across all trials to get the final values and the 95% CIs. For pre-mating processes I am focusing on mating success and then for post-mating processes I am looking at the total number of eggs transferred/received and the proportion of those eggs which developed (showing fertilization success).

```{r opp-select-episodes-females}

#Create a dataframe to store all of the intermediate values of fitness in
fem_succ_fitness <- data.frame(matrix(ncol = ncol(fem_succSS) + 9,
                                      nrow = 0))
colnames(fem_succ_fitness) <- c(colnames(fem_succSS),
                                "w1", "w1_squared",
                                "W2", "W2_bar", "w2",
                                "W3", "W3_bar", "w3", "i3")

#Create a dataframe to store the final calculations of I in
opp_selection_episodes_fem <- data.frame(matrix(ncol = 12,
                                            nrow = 0))
colnames(opp_selection_episodes_fem) <- c("trial_num", "I_1", "I_1per", "I_2", "I_2per", 
                                          "I_3", "I_3per", "I_12", "I_12per",
                                          "I", "Iper")

for (trial in unique(fem_succSS$trial_num)) {
  
  #Subset the overall dataframe to work with an individual trial
  tmp <- fem_succSS[fem_succSS$trial_num == trial, ]
  
  #Calculate the absolute pre-copulatory fitness (Eq. 14 Arnold & Wade 1984)
  #This is the same as the calculation of I_s
  tmp$w1 <- tmp$MatingSuccess/mean(tmp$MatingSuccess) #Relative mating success
  tmp$w1_squared <- (tmp$w1)^2
  
  I_1 <- var(tmp$w1) #Variance in relative mating success
  
  #Post-copulatory selection event 1 (Number of eggs transferred) (Eq. 15 Arnold & Wade 1984)
  tmp$W2 <- ifelse(tmp$MatingSuccess > 0,
                   tmp$totalEggs/tmp$MatingSuccess,
                   0) #Number of eggs per mate
  tmp$W2_bar <- tmp$W2 * (tmp$w1/nrow(tmp)) #Number of eggs per mate adjusted by the # of individuals with fitness W
  tmp$w2 <- tmp$W2/sum(tmp$W2_bar)
  
  I_2 <- (sum((tmp$w1 * (tmp$w2)^2))/nrow(tmp) - 1) * nrow(tmp)/(nrow(tmp) - 1)
  
  #Post-copulatory selection event 2 (Number of eggs developed) (Eq. 16 Arnold & Wade 1984)
  tmp$W3 <- ifelse(tmp$totalEggs > 0,
                   tmp$NumDeveloped/tmp$totalEggs,
                   0) #Proportion of transferred eggs that developed
  tmp$W3_bar <- tmp$W3 * ((tmp$totalEggs/mean(tmp$totalEggs))/nrow(tmp)) #Prop. of eggs developed adjusted by the # of individuals with fitness W
  tmp$w3 <- tmp$W3/sum(tmp$W3_bar)
  tmp$i3 <- ((tmp$totalEggs/mean(tmp$totalEggs))/nrow(tmp)) * ((tmp$w3 - 1)^2)
  
  I_3 <- sum(tmp$i3) * nrow(tmp)/(nrow(tmp) - 1)

  I_12 <- var(tmp$totalEggs)/(mean(tmp$totalEggs)^2)
  
  #Total opportunity for selection
  I <- var(tmp$NumDeveloped)/(mean(tmp$NumDeveloped)^2)
  
  #Calculating percentages for each selection event
  I_1per <- (I_1/I)*100
  I_2per <- (I_2/I)*100
  I_3per <- (I_3/I)*100
  I_12per <- (I_12/I)*100
  Iper <- (I/I)*100
  
  #Combining all of the selection values (Is) and saving the output
  trial_num <- as.numeric(gsub("^(C)(\\d)", "\\2",
                               trial))
  selection <- cbind(trial_num, I_1, I_1per, I_2, I_2per, I_3, I_3per,
                     I_12, I_12per, I, Iper)
  
  opp_selection_episodes_fem <- rbind(opp_selection_episodes_fem, selection)
  
  #Save the intermediate values
  fem_succ_fitness <- rbind(fem_succ_fitness, tmp)
}

#Exporting the data
#write.csv(fem_succ_fitness, "data/scovelli_int_I_fem.csv", row.names = FALSE)
```

```{r opp-select-episodes-males}
#Create a dataframe to store all of the intermediate values of fitness in
mal_succ_fitness <- data.frame(matrix(ncol = ncol(mal_succSS) + 9,
                                      nrow = 0))
colnames(mal_succ_fitness) <- c(colnames(mal_succSS),
                                "w1", "w1_squared",
                                "W2", "W2_bar", "w2",
                                "W3", "W3_bar", "w3", "i3")

#Create a dataframe to store the final calculations of I in
opp_selection_episodes_mal <- data.frame(matrix(ncol = 12,
                                            nrow = 0))
colnames(opp_selection_episodes_mal) <- c("trial_num", "I_1", "I_1per", "I_2", "I_2per", 
                                          "I_3", "I_3per", "I_12", "I_12per",
                                          "I", "Iper", "I_s")

for (trial in unique(mal_succSS$trial_num)) {
  
  #Subset the overall dataframe to work with an individual trial
  tmp <- mal_succSS[mal_succSS$trial_num == trial, ]
  
  #Calculate the absolute pre-copultory fitness (Eq. 14 Arnold & Wade 1984)
  tmp$w1 <- tmp$MatingSuccess/mean(tmp$MatingSuccess) #Relative mating success
  tmp$w1_squared <- (tmp$w1)^2
  
  I_1 <- var(tmp$w1) #Variance in relative mating success
  
  #Post-copulatory selection event 1 (Number of eggs transferred) (Eq. 15 Arnold & Wade 1984)
  tmp$W2 <- ifelse(tmp$MatingSuccess > 0,
                   tmp$totalEggs/tmp$MatingSuccess,
                   0) #Number of eggs per mate
  tmp$W2_bar <- tmp$W2 * (tmp$w1/nrow(tmp)) #Number of eggs per mate adjusted by the # of individuals with fitness W
  tmp$w2 <- tmp$W2/sum(tmp$W2_bar)
  
  I_2 <- (sum((tmp$w1 * (tmp$w2)^2))/nrow(tmp) - 1) * nrow(tmp)/(nrow(tmp) - 1)
  
  #Post-copulatory selection event 2 (Number of eggs developed) (Eq. 16 Arnold & Wade 1984)
  tmp$W3 <- ifelse(tmp$totalEggs > 0,
                   tmp$NumDeveloped/tmp$totalEggs,
                   0) #Proportion of transferred eggs that developed
  tmp$W3_bar <- tmp$W3 * ((tmp$totalEggs/mean(tmp$totalEggs))/nrow(tmp)) #Prop. of eggs developed adjusted by the # of individuals with fitness W
  tmp$w3 <- tmp$W3/sum(tmp$W3_bar)
  tmp$i3 <- ((tmp$totalEggs/mean(tmp$totalEggs))/nrow(tmp)) * ((tmp$w3 - 1)^2)
  
  I_3 <- sum(tmp$i3) * nrow(tmp)/(nrow(tmp) - 1)

  I_12 <- var(tmp$totalEggs)/(mean(tmp$totalEggs)^2)
  
  #Total opportunity for selection
  I <- var(tmp$NumDeveloped)/(mean(tmp$NumDeveloped)^2)

  #Calculating percentages for each selection event
  I_1per <- (I_1/I)*100
  I_2per <- (I_2/I)*100
  I_3per <- (I_3/I)*100
  I_12per <- (I_12/I)*100
  Iper <- (I/I)*100
  
  #Combining all of the selection values (Is) and saving the output
  trial_num <- as.numeric(gsub("^(C)(\\d)", "\\2",
                               trial))
  selection <- cbind(trial_num, I_1, I_1per, I_2, I_2per, I_3, I_3per,
                     I_12, I_12per, I, Iper)
  
  opp_selection_episodes_mal <- rbind(opp_selection_episodes_mal, selection)
  
  #Save the intermediate values
  mal_succ_fitness <- rbind(mal_succ_fitness, tmp)
}

#Exporting the data
#write.csv(mal_succ_fitness, "data/scovelli_int_I_mal.csv", row.names = FALSE)
```

```{r select-episodes-CI}
#Merge the selection coefficients from males and females into one dataset to 
#make life easier
opp_selection_episodes_fem$Sex <- "F"
opp_selection_episodes_mal$Sex <- "M"

opp_selection_episodes_all <- rbind(opp_selection_episodes_fem, opp_selection_episodes_mal)

#Exporting the data
#write.csv(opp_selection_episodes_all, "data/scovelli_opp_selection.csv", row.names = FALSE)

#List the columns of interest
columns <- c("I_1", "I_2", "I_12", "I_3","I")

#Create a dataframe to store the final values in
opp_episodes_average <- data.frame(matrix(ncol = 4,
                                    nrow = 0))
colnames(opp_episodes_average) <- c("Average", "Interval", 
                                    "Episode_sel", "Sex")

#Calculate the critical value
crit <- qt(p = 0.975, df = (nrow(opp_selection_episodes_fem) - 1))

for (j in 1:length(columns)) {
    
    col_name <- columns[[j]]
    
    #Calculate the means
    mean <- t(t(tapply(opp_selection_episodes_all[, colnames(opp_selection_episodes_all) 
                                                  == col_name], 
                       opp_selection_episodes_all$Sex, 
                       mean)))
    
    #Calculate standard error
    se <- t(t(tapply(opp_selection_episodes_all[, colnames(opp_selection_episodes_all) 
                                                == col_name], 
                     opp_selection_episodes_all$Sex, 
                 function(x){
                   sqrt(var(x))/sqrt(length(x))
                 })))
    
    #Calculate the value that is added and subtracted from the mean
    int <- se*crit
    
    #Combine the data together
    episode <- as.data.frame(cbind(mean, int))
    colnames(episode) <- c("Average", "Interval")
    
    episode$Episode_sel <- col_name
    episode$Sex <- rownames(episode)
    
    rownames(episode) <- NULL
    
    opp_episodes_average <- rbind(opp_episodes_average, episode)
    
  }


```

Let's now explore some results:

```{r opp-select-episodes-table, echo = FALSE, warning=FALSE}

#Create a new column
opp_episodes_average <- opp_episodes_average %>%
  mutate(Combined = paste0(round(Average , 3), 
                           " (", round(Average - Interval, 2), ", ",
                           round(Average + Interval, 2), ")"))

#Transform data into wide format
sum_table <- opp_episodes_average %>% 
  select(Episode_sel, Sex, Combined) %>% 
  pivot_wider(names_from = Sex, values_from = Combined) 

#Display the table
kable(sum_table, caption = "Average Episode of Selection (95% CI) for Males and Females")

```


```{r opp-select-episodes-figure, echo=FALSE, fig.cap="_Average opportunity for selection for the different episodes for male (purple) and female (green) S. scovelli. Errorbars represent the 95% confidence intervals around the mean_", fig.width=8, fig.height=6, warning=FALSE}

#Set parameters

ggplot(opp_episodes_average,
       aes(x = Episode_sel,
           y = Average,
           color = Sex,
           group = Sex)) +
  geom_errorbar(aes(ymin = Average - Interval,
                    ymax = Average + Interval),
                color = "black",
                width = 0.2,
                position = pd,
                linewidth = 1) +
  geom_point(position = pd,
             size = 4) +
  xlab("Episode of Selection") +
  ylab("Average Fitness Value") +
  scale_color_manual(values = sex_cols) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  theme(legend.position = "bottom",
        legend.key=element_blank(),
        axis.title.x = element_text(size = 16,
                                    vjust = -0.5),
        axis.text.x = element_text(size = 16, family = "serif"),
        axis.title.y = element_text(size = 16,
                                    vjust = 2.5),
        axis.text.y = element_text(size = 16),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12)) +
  geom_hline(yintercept = 0, linetype = "dashed", size = 1)

```

From the table and the plot we can see that once again there are some significant differences in the selection between males and females. 

Let's now look more into the percentage of the overall opportunity for selection made up for by each individual episode of selection:

```{r calc-opp-percents}

sexes <- c("M", "F")

#Create a dataframe to store the final values in
opp_percents <- data.frame(matrix(ncol = 3,
                                 nrow = 0))
colnames(opp_percents) <- c("Percent", "Episode_sel", "Sex")

#Calculate the percentage for each episode in the two sexes
for (sex in sexes) {
    
  #subset dataset based on sex
  tmp_sex <- opp_episodes_average[opp_episodes_average$Sex == sex, ]
  
  #Pull out the overall opp. for selection value
  I_average <- tmp_sex$Average[tmp_sex$Episode_sel == "I"]
  
  #Calculate what percentage of the I is represented by each episode
  percents <- as.data.frame(t(t(apply(tmp_sex, 1, function(x){
      
      (as.numeric(x[1])/I_average)*100
      
    }))))
    
    colnames(percents) <- "Percent"
    percents$Episode_sel <- tmp_sex$Episode_sel
    percents$Sex <- sex
    
    rownames(percents) <- NULL
    
    opp_percents <- rbind(opp_percents, percents)
    
  }

```

```{r generate-figa-opp-selection, echo=FALSE, warning=FALSE, fig.cap="_The proportion of the total opportunity for selection that is represented by each episode of selection for males and females._"}

selection_colors <- c("I_1" = "#9FBCAA", "I_2" = "#F0B67F", "I_3" = "#CD96CD", "I_12" = "#6CA6CD")

ggplot(opp_percents[!(opp_percents$Episode_sel %in% c("I", "I_12")),], 
       aes(x = Sex, 
           y = Percent, 
           fill = Episode_sel)) +
  geom_bar(position = "stack", stat = "identity") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  scale_fill_manual(values = selection_colors) +
   theme(legend.position = "right",
        legend.key=element_blank(),
        axis.title.x = element_text(size = 16,
                                    vjust = -0.5),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 16,
                                    vjust = 2.5),
        axis.text.y = element_text(size = 12),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12, family = "serif"))

```

Matching the previous plots, most of the opportunity for selection in _Syngnathus scovelli_ females can be attributed to variance in mating success ($I_1$) rather than variance in eggs transferred/received ($I_2$) or variance in the proportion of eggs developed ($I_3$). However, for males it appears that post-copulatory selection may be more important. This may be a result of males only having the capacity to mate once, meaning there is less variation in the mating success (i.e, they either mate or they don't).

