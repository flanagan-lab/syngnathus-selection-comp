---
title: "Selection pressures in _Syngnathus fuscus_"
output: 
  github_document:
    toc: true
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='../',
                     fig_path="../figs/")
```

``` {r library, message = FALSE, warning = FALSE}
#This is a cohesive list of all the libraries used in this document
library(ggplot2)
library(cowplot)
library(fBasics)
library(pwr)
library(lme4)
library(dplyr)
library(tidyr)
library(knitr)

```

``` {r read-data, message = FALSE, warning = FALSE}

#MomIDs and embryo counts for each section of the male's brood pouch
em_dat <- read.csv("data/EmbryoParentage_fuscus.csv")

#Metadata for males and females from the mesocosm experiments
fem_mesoFU <- read.csv("data/all_fem_meso_fuscus.csv")
mal_mesoFU <- read.csv("data/all_mal_meso_fuscus.csv")

```

This document will follow the same analysis as was outlined in `selection_analysis_floridae.Rmd`. For more thorough details refer back to that document.

# Calculating the degree of sexual dimorphism
I noticed that there was a certain degree of sexual dimorphism in terms of an ornamentation that was present only in the females, but I also want to explore any size sexual dimorphism that may be present in this species.

I will be looking at total standard length (mm, measured from the tip of the snout to the tip of the caudal fin), snout-vent length (mm, measured from the tip of the snout to the urogenital opening), torso depth (mm), and snout length (mm). To look at these differences I will be performing t-tests between males and females. First, I need to see if assumptions are met, i.e. variances are equal and data is normally distributed.

## Checking the assumptions for a pairwise comparison
 The main two things that I will be looking into include:

1. Equal variances between my groups (using `var.test()`).
2. Normal distribution of the data (using `normalTest()`).

To account for the fact that fish who are longer may just inherently be deeper as well, I am going to adjust the depth by the standard length of the pipefish prior to running any analyses.

```{r assump-test}
#Adjust the torso depth
fem_mesoFU$depth_adj <- fem_mesoFU$depth/fem_mesoFU$length
mal_mesoFU$depth_adj <- mal_mesoFU$depth/mal_mesoFU$length

#Testing to see if the variances are equal
var.test(fem_mesoFU$length, mal_mesoFU$length) #EQUAL
var.test(fem_mesoFU$depth_adj, mal_mesoFU$depth_adj) #NOT EQUAL
var.test(fem_mesoFU$svl, mal_mesoFU$svl) #EQUAL

#Testing for normal distribution - Females
normalTest(fem_mesoFU$length, method = "da") #NORMAL
normalTest(fem_mesoFU$depth_adj, method = "da") #NOT NORMAL
normalTest(fem_mesoFU$svl, method = "da") #NORMAL

#Testing for normal distribution - Males
normalTest(mal_mesoFU$length, method = "da") #NOT NORMAL
normalTest(mal_mesoFU$depth_adj, method = "da") #NORMAL
normalTest(mal_mesoFU$svl, method = "da") #NORMAL

```

## Investigate distributions and run the tests
I will run a Wilcoxon test for standard length, a two sample t-test for snout-vent length, and a Wilcoxon test for torso depth (adjusted).

```{r histogram_sizes, message=FALSE, warning = FALSE, echo = FALSE, fig.cap="_Histograms of male and female pipefish body sizes._", fig.width=15}
#Combining the datasets
fem_mesoFU$Sex <- "F"
mal_mesoFU$Sex <- "M"
all_sex_meso <- rbind(fem_mesoFU[, c("length", "depth_adj", "svl", "Sex")], mal_mesoFU[, c("length", "depth_adj", "svl", "Sex")])

length <- ggplot(data = all_sex_meso, aes(x = length)) +
  geom_histogram(aes(fill = Sex),
                 alpha = 0.5,
                 position = 'identity') +
  scale_fill_manual(values = c("#7fc97f75", "#beaed475")) +
  theme_minimal() +
  labs(x = "Length (mm)",
       y = "Number of Pipefish",
       title = "Length of male and female pipefish")

depth <- ggplot(data = all_sex_meso, aes(x = depth_adj)) +
  geom_histogram(aes(fill = Sex),
                 alpha = 0.5,
                 position = 'identity') +
  scale_fill_manual(values = c("#7fc97f75", "#beaed475")) +
  theme_minimal() +
  labs(x = "Depth (mm)",
       y = "Number of Pipefish",
       title = "Depth of male and female pipefish")

svl <- ggplot(data = all_sex_meso, aes(x = svl)) +
  geom_histogram(aes(fill = Sex),
                 alpha = 0.5,
                 position = 'identity') +
  scale_fill_manual(values = c("#7fc97f75", "#beaed475")) +
  theme_minimal() +
  labs(x = "SVL (mm)",
       y = "Number of Pipefish",
       title = "Snout-vent length of male and female pipefish")

plot_grid(length, depth, svl,
          ncol = 3)

```

```{r t-test-sd}
#Running the appropriate test
wilcox.test(fem_mesoFU$length, mal_mesoFU$length)
wilcox.test(fem_mesoFU$depth_adj, mal_mesoFU$depth_adj)
t.test(fem_mesoFU$svl, mal_mesoFU$svl, var.equal = TRUE)
```

For the Northern pipefish, there are significant differences between males and females in terms of standard length, snout-vent length, and torso depth. 

```{r power-test}

#Checking the power - length
d_mean_len <- abs(mean(fem_mesoFU$length, na.rm = TRUE) - 
                    mean(mal_mesoFU$length, na.rm = TRUE))
pool_sd_len <- sqrt((var(fem_mesoFU$length, na.rm = TRUE) + 
                       var(mal_mesoFU$length, na.rm = TRUE))/ 2)
d_len <- d_mean_len/pool_sd_len

pwr.t.test(n = nrow(fem_mesoFU), 
           d = d_len,
           sig.level = 0.05,
           type = 'two.sample',
           alternative = 'two.sided')

#Checking the power - SVL
d_mean_svl <- abs(mean(fem_mesoFU$svl, na.rm = TRUE) - 
                    mean(mal_mesoFU$svl, na.rm = TRUE))
pool_sd_svl <- sqrt((var(fem_mesoFU$svl, na.rm = TRUE) + 
                       var(mal_mesoFU$svl, na.rm = TRUE))/ 2)
d_svl <- d_mean_svl/pool_sd_svl

pwr.t.test(n = nrow(fem_mesoFU), 
           d = d_svl,
           sig.level = 0.05,
           type = 'two.sample',
           alternative = 'two.sided')

#Checking the power - Depth
d_mean_depth <- abs(mean(fem_mesoFU$depth_adj, na.rm = TRUE) - 
                      mean(mal_mesoFU$depth_adj, na.rm = TRUE))
pool_sd_depth <- sqrt((var(fem_mesoFU$depth_adj, na.rm = TRUE) + 
                         var(mal_mesoFU$depth_adj, na.rm = TRUE))/ 2)
d_depth <- d_mean_depth/pool_sd_depth
pwr.t.test(n = nrow(fem_mesoFU), 
           d = d_depth,
           sig.level = 0.05,
           type = 'two.sample',
           alternative = 'two.sided')

```

For all variables we have a power of over 0.9 or over 90% so we can be confident in our interpretation.

# Calculating mating and reproductive success for individuals who mated
_Syngnathus fuscus_ (Northern pipefish) were sampled from one cohesive seagrass beds in Chesapeake Bay in Cape Charles, Virgina. Sexually mature females (standard length $\ge$ 120mm) and pregnant males were collected and brought back to the University of Tampa for mesocosm experiments. In these mesocosms, 6 males and 6 females were housed together in a 140L tank for a period of 6-weeks and allowed to mate freely. Parentage analysis was done with all of the pregnant males from the trials to figure out how many times each male and female mated, and the number of eggs that were transferred. The results of that are here.

First I had to calculate the mating and reproductive success for each male and female who mated based on the assigned mom for each genotyped embryo.

```{r calc-success, file="R/calc_fitness.R", warning=FALSE}

```

After running the above R script we have generated two datasets, `mal_fitness` and `fem_fitness`. These datasets include information about the mating success (number of mates) and reproductive success (Number of embryos transferred). We can split reproductive success up further later if we want to from the total number of embryos transferred to the number of embryos developed and the number that were undeveloped. 

I want to include all of the other metadata that I have for these individuals (traits, collection location, latency to pregnancy, etc.) as well as tack on all of the information for the individuals who did not mate. To do that I am going to need to merge the fitness datasets with `fem_meso` and `mal_meso`.

```{r merge-fit-meso}
#Make a column in *_meso that contains the full fishID (i.e. FU1M3) to match the 
#formatting in the fitness datasets (make sure they have the same name for merging purposes)
fem_mesoFU$momID <- paste0("FU", fem_mesoFU$trial_num, "F",
                         fem_mesoFU$fishID)
mal_mesoFU$maleID <- paste0("FU", mal_mesoFU$trial_num, "M",
                          mal_mesoFU$fishID)

#Merge the datasets based on the columns created above
fem_all <- merge(fem_mesoFU, fem_fitness, by = "momID", 
                 all.x = TRUE, all.y = TRUE)
mal_all <- merge(mal_mesoFU, mal_fitness, by = "maleID", 
                 all.x = TRUE, all.y = TRUE)
```

There are a few trials that I want to remove from the analysis including all trials where there were no successful matings (4, 7, 8, and 9).
  
I also want to replace the NAs that were automatically added to the columns from the fitness dataset (MatingSuccess, NumDeveloped, NumUndeveloped, totalEggs) with 0s and add a column to the female dataset that tells me whether or not the female mated (with 1 or 0).
  
```{r subset-successful-trials}
#Subset the merged datasets to remove trials without successful matings 
fem_succFU <- subset(fem_all, !(trial_num %in% c(4, 7, 8, 9)))
mal_succFU <- subset(mal_all, !(trial_num %in% c(4, 7, 8, 9)))

#Replace NAs with 0s in the columns related to fitness
mal_succFU[, c("MatingSuccess", "NumDeveloped_Calc", 
               "NumUndeveloped_Calc", "totalEggs")] <- sapply(mal_succFU[,
                                                                         c("MatingSuccess", "NumDeveloped_Calc", 
               "NumUndeveloped_Calc", "totalEggs")],
                           function(x)
                             ifelse(is.na(x), 0, x))

fem_succFU[, c("MatingSuccess", "NumDeveloped", 
               "NumUndeveloped", "totalEggs")] <- sapply(fem_succFU[, c("MatingSuccess", 
                                                                        "NumDeveloped", 
                                                                        "NumUndeveloped", 
                                                                        "totalEggs")],
                           function(x)
                             ifelse(is.na(x), 0, x))

#Add a column for females to denote mated or unmated
fem_succFU$mated <- ifelse(fem_succFU$MatingSuccess > 0, 1, 0)

```

# Summary statistics for successfully mated individuals
## Males
Across all `r length(unique(mal_succFU$trial_num))` trials and `r nrow(mal_succFU)` total males, there were `r nrow(mal_succFU[mal_succFU$preg_status == 1,])` males that mated at least one time and `r nrow(mal_succFU[mal_succFU$MatingSuccess > 1,])` of those males had two mates. 

Looking across all males, including the ones that did not mate, this is what we find as the mean, sd, and se for the number of embryos transferred and how many of those developed versus didn't:

|                  | mean| SD| SE| max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(mal_succFU$totalEggs)`|`r sd(mal_succFU$totalEggs)`|  `r sd(mal_succFU$totalEggs)/sqrt(nrow(mal_succFU))`|`r max(mal_succFU$totalEggs)` | `r min(mal_succFU$totalEggs)`|
|Developed Embryos | `r mean(mal_succFU$NumDeveloped)`|`r sd(mal_succFU$NumDeveloped)`|  `r sd(mal_succFU$NumDeveloped)/sqrt(nrow(mal_succFU))`|`r max(mal_succFU$NumDeveloped)` | `r min(mal_succFU$NumDeveloped)`|
|Undeveloped Embryos| `r mean(mal_succFU$NumUndeveloped)`|`r sd(mal_succFU$NumUndeveloped)`|  `r sd(mal_succFU$NumUndeveloped)/sqrt(nrow(mal_succFU))`|`r max(mal_succFU$NumUndeveloped)` | `r min(mal_succFU$NumUndeveloped)`|

These values will be influenced by the number of 0s coming from males who did not mate. So let's look at the same thing, but this time for only males who had at least one successful mating:

|                  | mean| SD| SE|  max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(mal_succFU$totalEggs[mal_succFU$preg_status == 1])`|`r sd(mal_succFU$totalEggs[mal_succFU$preg_status == 1])`|  `r sd(mal_succFU$totalEggs[mal_succFU$preg_status == 1])/sqrt(nrow(mal_succFU[mal_succFU$preg_status == 1,]))`| `r max(mal_succFU$totalEggs[mal_succFU$preg_status == 1])` | `r min(mal_succFU$totalEggs[mal_succFU$preg_status == 1])` |
|Developed Embryos | `r mean(mal_succFU$NumDeveloped[mal_succFU$preg_status == 1])`|`r sd(mal_succFU$NumDeveloped[mal_succFU$preg_status == 1])`|  `r sd(mal_succFU$NumDeveloped[mal_succFU$preg_status == 1])/sqrt(nrow(mal_succFU[mal_succFU$preg_status == 1,]))`|`r max(mal_succFU$NumDeveloped[mal_succFU$preg_status == 1])` | `r min(mal_succFU$NumDeveloped[mal_succFU$preg_status == 1])` |
|Undeveloped Embryos| `r mean(mal_succFU$NumUndeveloped[mal_succFU$preg_status == 1])`|`r sd(mal_succFU$NumUndeveloped[mal_succFU$preg_status == 1])`|  `r sd(mal_succFU$NumUndeveloped[mal_succFU$preg_status == 1])/sqrt(nrow(mal_succFU[mal_succFU$preg_status == 1,]))`| `r max(mal_succFU$NumUndeveloped[mal_succFU$preg_status == 1])` | `r min(mal_succFU$NumUndeveloped[mal_succFU$preg_status == 1])` |

We can see from the bottom table that even when we only include males who mated there is still a wide range in the brood size. I want to see what relationship there is between brood pouch size (in terms of both total area and length) and brood size (total number of embryos).

```{r em-v-bp, echo=FALSE, fig.cap="_Scatterplot of the relationship between brood pouch size metrics and the number of embryos a male had._", fig.width=15, fig.height=10 }
#create a subset of only the males who mated
mated_malFU <- mal_succFU[mal_succFU$preg_status == 1, ]

#Plot brood size against the different metrics for pouch size
par(mfrow=c(1,2))
plot(mated_malFU$bp_area,
     mated_malFU$totalEggs,
     xlab = expression(paste("Brood Pouch Area (mm"^2*")")),
     ylab = "Brood Size (# embryos)",
     col = "darkorange",
     pch = 19)
abline(lm(mated_malFU$totalEggs ~ as.numeric(mated_malFU$bp_area)), lwd = 3, lty = 2)
plot(mated_malFU$bp_length,
     mated_malFU$totalEggs,
     xlab = "Brood Pouch Length (mm)",
     ylab = "Brood Size (# embryos)",
     col = "cyan4",
     pch = 19)
abline(lm(mated_malFU$totalEggs ~ as.numeric(mated_malFU$bp_length)), lwd = 3, lty = 2)
```

There may be some correlation happening here, but it doesn't look particularly strong. Let's run some correlations tests to see what they say.

```{r eggs-bp-cor, echo=FALSE}
cor.test(as.numeric(mated_malFU$bp_area), mated_malFU$totalEggs)
cor.test(as.numeric(mated_malFU$bp_length), mated_malFU$totalEggs)
```

There is not a significant correlation between the number of eggs and size of the brood pouch when we look at brood pouch area OR brood pouch length. 

Let's see if this changes if we just look at the overall size of the male

```{r em-v-sl, echo=FALSE, fig.cap="_Scatterplot of the relationship between standard length (mm) and the number of embryos a male had._", fig.width=15, fig.height=10}
plot(mated_malFU$length,
     mated_malFU$totalEggs,
     xlab = "Standard Length (mm)",
     ylab = "Brood Size (# embryos)",
     col = "#CD5C5C75",
     pch = 19,
     cex = 1.5
)
abline(lm(mated_malFU$totalEggs ~ as.numeric(mated_malFU$length)), lwd = 3, lty = 2)
```

```{r eggs-sl-cor, echo=FALSE}
cor.test(as.numeric(mated_malFU$length), mated_malFU$totalEggs)
```

The correlation actually decreases when we look at the overall size of the fish.

## Females
Across all `r length(unique(fem_succFU$trial_num))` trials and `r nrow(fem_succFU)` total females, there were `r nrow(fem_succFU[fem_succFU$mated == 1,])` females that mated at least one time, `r nrow(fem_succFU[fem_succFU$MatingSuccess == 2,])` females that mated twice, and `r nrow(fem_succFU[fem_succFU$MatingSuccess == 3,])` that mated 3 times. 

Looking across all females, including the ones that did not mate, this is what we find as the mean, sd, and se for the total number of embryos transferred from each female (across all of her mates if applicable) and how many of those developed versus didn't:

|                  | mean| SD| SE| max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(fem_succFU$totalEggs)`|`r sd(fem_succFU$totalEggs)`|  `r sd(fem_succFU$totalEggs)/sqrt(nrow(fem_succFU))`|`r max(fem_succFU$totalEggs)` | `r min(fem_succFU$totalEggs)`|
|Developed Embryos | `r mean(fem_succFU$NumDeveloped)`|`r sd(fem_succFU$NumDeveloped)`|  `r sd(fem_succFU$NumDeveloped)/sqrt(nrow(fem_succFU))`|`r max(fem_succFU$NumDeveloped)` | `r min(fem_succFU$NumDeveloped)`|
|Undeveloped Embryos| `r mean(fem_succFU$NumUndeveloped)`|`r sd(fem_succFU$NumUndeveloped)`|  `r sd(fem_succFU$NumUndeveloped)/sqrt(nrow(fem_succFU))`|`r max(fem_succFU$NumUndeveloped)` | `r min(fem_succFU$NumUndeveloped)`|

These values will be influenced by the number of 0s coming from females who did not mate. So let's look at the same thing, but this time for only females who had at least one successful mating:

|                  | mean| SD| SE|  max | min |
|:-----------------|----:|---:|----:|----:|----:|
|Number of Embryos | `r mean(fem_succFU$totalEggs[fem_succFU$mated == 1])`|`r sd(fem_succFU$totalEggs[fem_succFU$mated == 1])`|  `r sd(fem_succFU$totalEggs[fem_succFU$mated == 1])/sqrt(nrow(fem_succFU[fem_succFU$mated == 1,]))`| `r max(fem_succFU$totalEggs[fem_succFU$mated == 1])` | `r min(fem_succFU$totalEggs[fem_succFU$mated == 1])` |
|Developed Embryos | `r mean(fem_succFU$NumDeveloped[fem_succFU$mated == 1])`|`r sd(fem_succFU$NumDeveloped[fem_succFU$mated == 1])`|  `r sd(fem_succFU$NumDeveloped[fem_succFU$mated == 1])/sqrt(nrow(fem_succFU[fem_succFU$mated == 1,]))`|`r max(fem_succFU$NumDeveloped[fem_succFU$mated == 1])` | `r min(fem_succFU$NumDeveloped[fem_succFU$mated == 1])` |
|Undeveloped Embryos| `r mean(fem_succFU$NumUndeveloped[fem_succFU$mated == 1])`|`r sd(fem_succFU$NumUndeveloped[fem_succFU$mated == 1])`|  `r sd(fem_succFU$NumUndeveloped[fem_succFU$mated == 1])/sqrt(nrow(fem_succFU[fem_succFU$mated == 1,]))`| `r max(fem_succFU$NumUndeveloped[fem_succFU$mated == 1])` | `r min(fem_succFU$NumUndeveloped[fem_succFU$mated == 1])` |

We can see from the bottom table that even when we only include females who mated there is still a wide range in the number of eggs transferred. I want to see what relationship there may be between female body size (in terms of standard length, depth, and SVL) and the number of eggs she transferred. I also want to see on average how many eggs were transferred per mating. I'm going to calculate this by taking the total number of eggs and dividing it by the number of mates. 

```{r egg-per-mate-fem, echo=FALSE}
eggs_per_mate <- fem_succFU$totalEggs/fem_succFU$MatingSuccess
mean(eggs_per_mate, na.rm = TRUE)
sd(eggs_per_mate, na.rm = TRUE)/sqrt(length(eggs_per_mate))
```

```{r em-v-fem-size, echo=FALSE, fig.cap="Scatterplot of the relationship between female size metrics and the number of eggs transferred.", fig.width=15, fig.height=5}
#create a subset of only the females who mated
mated_femFU <- fem_succFU[fem_succFU$mated == 1, ]

#Plot total number of eggs transferred against the different metrics for females size
par(mfrow=c(1,3))
plot(mated_femFU$length,
     mated_femFU$totalEggs,
     xlab = "Length (mm)",
     ylab = "Number of eggs transferred",
     col = "darkorange",
     pch = 19)
abline(lm(mated_femFU$totalEggs ~ mated_femFU$length), lwd = 3, lty = 2)
plot(mated_femFU$depth_adj,
     mated_femFU$totalEggs,
     xlab = "Depth (mm)",
     ylab = "Number of eggs transferred",
     col = "cyan4",
     pch = 19)
abline(lm(mated_femFU$totalEggs ~ mated_femFU$depth_adj), lwd = 3, lty = 2)
plot(mated_femFU$svl,
     mated_femFU$totalEggs,
     xlab = "Snout-vent Length (mm)",
     ylab = "Number of eggs transferred",
     col = "purple",
     pch = 19)
abline(lm(mated_femFU$totalEggs ~ mated_femFU$svl), lwd = 3, lty = 2)

```

There also appears to be a correlation between female body size and the number of eggs transferred, especially in terms of depth. Let's run some correlations tests to see what they say.

```{r eggs-fem-size-cor, echo=FALSE}
cor.test(mated_femFU$length, as.numeric(mated_femFU$totalEggs))
cor.test(mated_femFU$depth_adj, as.numeric(mated_femFU$totalEggs))
cor.test(mated_femFU$svl, as.numeric(mated_femFU$totalEggs))

```

There is no sig. correlation between length or svl and the number of eggs transferred but we do see a significantly positive relationship between depth and number of eggs transferred!
