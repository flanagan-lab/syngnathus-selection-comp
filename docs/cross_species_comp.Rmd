---
title: "Comparing selection pressures across the three species of _Syngnathus_"
author: Coley Tosto
output: 
  github_document:
    toc: true
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='../',
                     fig_path="../figs/")
```

``` {r library, message = FALSE, warning = FALSE}
#This is a cohesive list of all the libraries used in this document
library(lme4)
library(spfTools)
library(magick)
library(patchwork)
library(ggplot2)

```

``` {r read-data, message = FALSE, warning = FALSE}
##Data for the Opportunity of selection
opp_select <- read.csv("data/episode_select_data.csv", header = TRUE)

##Data for generating the female bateman gradients
FL_fem_bateman <- read.csv("data/FL_fem_bateman.csv", header = TRUE)
FL_fem_bateman$species <- rep("floridae", times = nrow(FL_fem_bateman))

FU_fem_bateman <- read.csv("data/FU_fem_bateman.csv", header = TRUE)
FU_fem_bateman$species <- rep("fuscus", times = nrow(FU_fem_bateman))

SS_fem_bateman <- read.csv("data/SS_fem_bateman.csv", header = TRUE)
SS_fem_bateman$species <- rep("scovelli", times = nrow(SS_fem_bateman))


FL_fem_fitness <- read.csv("data/fem_fitnessFL.csv", header = TRUE)
FL_fem_fitness$species <- rep("floridae", times = nrow(FL_fem_fitness))

FU_fem_fitness <- read.csv("data/fem_fitnessFU.csv", header = TRUE)
FU_fem_fitness$species <- rep("fuscus", times = nrow(FU_fem_fitness))

SS_fem_fitness <- read.csv("data/fem_fitnessSS.csv", header = TRUE)
SS_fem_fitness$species <- rep("scovelli", times = nrow(SS_fem_fitness))

```

## The Opportunity for Selection across Species
We can start by comparing the episodes of selection calculated for males and females across the species. The data I will be using for this includes the average selection across the trials for each episode along side the upper and lower percentile-based confidence intervals we generated from bootstrapping.

I am first going to plot the average fitness value with the confidence intervals as error bars. 

```{r opp-select-ave-CI}
#Set colors used for the two sexes
sex_cols <- c("F" = "#7fc97f", "M" = "#beaed4" )

#Create a vector of the species names
species_names <- c("S. floridae", "S. fuscus", "S. scovelli")

pdf("figs/opp_select_aveCI.pdf", width = 10, height=8)

#Set up the plotting parameters
par(mfrow = c(1, 3), 
    oma = c(4, 5, 2, 6),  
    mar = c(1, 1, 2, 1))

#Subset data to only keep the episodes of selection which we are interested in
opp_select_sub <- opp_select[opp_select$episode_sel %in% c("I", "I_1", "I_2", "I_12", "I_3"),]

#Set positioning for between m and f points
dodge_amount <- 0.4

#Define the desired order for x-axis
x_order <- c("I", "I_1", "I_12", "I_2", "I_3")
x_labels_orig <- x_order[x_order %in% unique(opp_select_sub$episode_sel)]

#Create subscripted labels to use for the plots
x_labels_display <- sapply(x_labels_orig, function(x) {
  
  if (grepl("_", x)) {
    
    parts <- strsplit(x, "_")[[1]]
    return(bquote(.(parts[1])[.(parts[2])]))
    
    } else {
      
      return(x)
    
      }
  })
  
#Loop through the three species and plot data
for (i in 1:length(unique(opp_select_sub$species))) {
  
  #Subset for the species of interest
  species_data <- opp_select_sub[opp_select_sub$species == species_levels[i], ]
  
  #Set up empty plot with no axes
  plot(NULL, xlim = c(0, 5.5),
       ylim = c(0, 5),
       xlab = "", ylab = "",
       xaxt = "n", yaxt = "n",
       bty = "n")
  
  #Add the x-axis, adjusting fot the subscripted labels with mtext()
  axis(1, at = 1:5, labels = FALSE, lwd = 2)
  for (j in 1:5) {
    
    mtext(x_labels_display[[j]], side = 1, at = j, line = 1.5, family = "serif", cex = 1.3)
    
    }
  
  #Add y-axis only for the first plot, extend x-axis for the other two
  if (i == 1) {
    
    axis(2, cex.axis = 1.8, lwd = 2)
    box(bty = "l", lwd = 2)  
    
  } else {
    
      axis(1, at = 0:6, labels = NA, family = "serif", cex.axis = 1, las = 2, lwd = 2, lwd.ticks = NA)
    
  }
  
  #Plot points and error bars for each sex
  for (j in 1:length(unique(opp_select_sub$sex))) {
    
    #Subset for the sex of interest
    sex_data <- species_data[species_data$sex == sex_levels[j], ]
    
    #Match x positions to categorical positions
    x_positions <- match(sex_data$episode_sel, x_labels_orig)
    
    #Apply position adjustment to the points
    x_pos <- x_positions + (j - (length(unique(opp_select_sub$sex)) + 1)/2) * dodge_amount
    
    #Add the error bars
    arrows(x_pos, 
           sex_data$lower,
           x_pos,
           sex_data$upper,
           angle = 90, code = 3, length = 0.1, lwd = 2, col = "black")
    
    #Add the points
    points(x_pos, sex_data$average_cal,
           pch = 15 + i,  
           col = sex_cols[unique(opp_select_sub$sex)[j]],
           cex = 3)
  }
  
  #Add species label as title
  mtext(bquote(italic(.(species_names[i]))), side = 3, line = -1, cex = 1.6)
}

#Add overall axis labels
mtext("Episode of Selection", side = 1, outer = TRUE, line = 2.0, cex = 1.3)
mtext("Average Fitness Value", side = 2, outer = TRUE, line = 2.5, cex = 1.3)

#Add a legend
par(fig = c(0, 1, 0, 1), oma = c(5, 5, 5, 0),
    mar = c(3, 1, 2, 1), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")

legend("right",
       c("Male", "Female"),
       col = c("#beaed4", "#7fc97f"),
       bty = 'n',
       cex = 2,
       pch = 16,
       ncol = 1)

dev.off()

#Reset par
par(mfrow = c(1, 1))

```

We can then visualize what percentage pre- versus post-copulatory episodes of selection make up in the total opportunity for selection. To do that we will assume that "I" is 100% and every other episode will make up some portion of that. 

First, we need to calculate the percentages.

```{r calc-opp-percents}
sexes <- c("M", "F")

#Create a dataframe to store the final values in
opp_percents <- data.frame(matrix(ncol = 4,
                                 nrow = 0))
colnames(opp_percents) <- c("Percent", "Species", "Episode_sel", "Sex")

for (pipefish in unique(opp_select_sub$species)) {
  
  #Subset for the species of interest
  tmp <- opp_select_sub[opp_select_sub$species == pipefish, ]
  
  for (sex in sexes) {
    
    #subset for the sex
    tmp_sex <- tmp[tmp$sex == sex, ]
    percents <- as.data.frame(t(t(apply(tmp_sex, 1, function(x){
      
      (as.numeric(x[1])/tmp_sex$average_cal[tmp_sex$episode_sel == "I"])*100
      
    }))))
    
    colnames(percents) <- "Percent"
    percents$Species <- pipefish
    percents$Episode_sel <- tmp_sex$episode_sel
    percents$Sex <- sex
    
    rownames(percents) <- NULL
    
    opp_percents <- rbind(opp_percents, percents)
    
  }
}
```

Once we have the percentages we can use them to generate stacked bar plots for the different species.

```{r opp-select-percent}
#Set the colors
selection_colors <- c("I_2" = "#2F97C1", "I_3" = "#C05746", "I_1" = "#FAC748")

#Filter data to keep the three episodes we want
opp_percents_sub <- opp_percents[opp_percents$Episode_sel %in% c("I_1", "I_2", "I_3"), ]

#List the sexes and episodes of selection
sex_list <- c("F", "M")
episodes <- c("I_1", "I_2", "I_3")

pdf("figs/opp_select_per.pdf", width = 8, height=8)

#Set up plotting parameters
par(mfrow = c(1, 3), 
    oma = c(4, 5, 2, 6),  # outer margins (bottom, left, top, right)
    mar = c(1, 1, 2, 1))   # inner margins

#Loop through species and create the box plots
for (i in 1:length(unique(opp_percents_sub$Species))) {

  ##Pull out the species of interest
  sp <- unique(opp_percents_sub$Species)[i]

  ##Create matrix for this species
  plot_matrix <- matrix(0, nrow = length(episodes), ncol = length(sex_list))
  rownames(plot_matrix) <- episodes
  colnames(plot_matrix) <- sex_list
  
  ##Loop through the episodes and sexes to fill in matrix with approriate values
  for (j in 1:length(episodes)) {
    for (k in 1:length(sex_list)) {
      
      subset_val <- plot_data[plot_data$Species == sp & 
                              plot_data$Episode_sel == episodes[j] & 
                              plot_data$Sex == sex_list[k], "Percent"]
      
      if (length(subset_val) > 0) {
        
        plot_matrix[j, k] <- subset_val
        
      }
    }
  }
  
  ##Create the stacked barplot
  bp <- barplot(plot_matrix, 
                col = selection_colors[episodes],
                border = NA,
                space = 0.2,
                axes = FALSE,
                ylim = c(0, 105),
                main = "",
                names.arg = rep("", ncol(plot_matrix)))
  
  ##Add axes
  axis(1, at = 1:2, labels = c("Female", "Male"), lwd = 2, cex.axis = 1.8)
  
  if (i == 1) {
    
    axis(2, las = 1, cex.axis = 1.8, lwd = 2)
    box(bty = "l", lwd = 2)
    
  }else{
    
      axis(1, at = 0:3, labels = NA, lwd = 2, lwd.ticks = NA)

  }
  
  #Add species label as title
  mtext(bquote(italic(.(species_names[i]))), side = 3, line = -1.4, cex = 1.6)
}

#Add overall axis labels
mtext("Sex", side = 1, outer = TRUE, line = 2, cex = 1.3)
mtext("Percent", side = 2, outer = TRUE, line = 3, cex = 1.3)

# Add legend
par(fig = c(0, 1, 0, 1), oma = c(5, 5, 5, 0),
    mar = c(3, 1, 2, 1), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")

legend("right", 
       legend = c(expression("I"[1]), expression("I"[2]), expression("I"[3])),
       fill = selection_colors[c("I_1", "I_2", "I_3")],
       border = NA,
       cex = 2,
       bty = "n",
       xpd = TRUE)

dev.off()

```


```{r fig-opp-select-assemble, message=FALSE}

figA <- image_ggplot(image_read_pdf('figs/opp_select_aveCI.pdf'),interpolate = TRUE)
figB <- image_ggplot(image_read_pdf('figs/opp_select_per.pdf'),interpolate = TRUE)

fig <- figA + figB + plot_annotation(tag_levels = "A")

ggsave("figs/fig_opp_select.pdf", fig, height = 5, width=11)
ggsave("figs/fig_opp_select.png", fig, height = 5, width=11)

```

## The Bateman Gradient - Comparing reproductive and mating success

For the Bateman gradient I will only be comparing females across the three species as they are the sex which consistently mates multiply.

```{r fem-bate,am}
fem_bateman_all <- rbind(FL_fem_bateman[,-4], FU_fem_bateman)
fem_bateman_all <- rbind(fem_bateman_all, SS_fem_bateman)

fem_bateman_all$species <- as.factor(fem_bateman_all$species)

species_cols <- c("floridae" = "#2F97C1",
                  "fuscus" = "#C05746",
                  "scovelli" = "#FAC748")
species_shapes <- c("floridae" = 15,
                  "fuscus" = 16,
                  "scovelli" = 17)

slopes <- numeric(length(levels(fem_bateman_all$species)))
names(slopes) <- levels(fem_bateman_all$species)

pdf("figs/fem_bateman.pdf", width = 8, height=8)

par(oma = c(2,2,1,1),
    mar = c(1,1,2,1),
    xpd = FALSE)

plot(fem_bateman_all$rel_repo_fitness ~ fem_bateman_all$MatingSuccess,
     ylab = "", xlab = "",
     bty = "n", type = "n", axes = FALSE)

axis(1, pos = 0, lwd = 2, cex = 2, cex.axis = 1.5, las=1)
axis(2, pos = 0, lwd = 2, cex = 2, cex.axis = 1.5, las = 1)

clip(0, 7.1, 0, 7.1)

for(species in levels(fem_bateman_all$species)){
  
  points(fem_bateman_all$rel_repo_fitness[fem_bateman_all$species == species] ~
           fem_bateman_all$MatingSuccess[fem_bateman_all$species == species],
         col = paste0(species_cols[species], "85"),
         pch = species_shapes[species],
         cex = 1.5)

}

x_seq <- seq(0, 7, length.out = 100)

for (sp in levels(fem_bateman_all$species)) {
  
  dat_sub <- subset(fem_bateman_all, species == sp)

  mod <- lmer(rel_repo_fitness ~ MatingSuccess + (1 | trial), data = dat_sub)
  new_dat <- data.frame(MatingSuccess = x_seq,
                          trial = NA) 
    
  preds <- predict(mod, newdata = new_dat, re.form = NA)
    
  lines(x_seq, preds,
        col = species_cols[sp],
        lwd = 3,
        lty = which(levels(fem_bateman_all$species) %in% sp),
        xpd = FALSE)
    
  cat(sp, "slope =", fixef(mod)["MatingSuccess"], "\n")
  slopes[sp] <- fixef(mod)["MatingSuccess"]
}

mtext("Relative Mating Success", 1 , cex = 1.5, line = 1.5)
mtext("Relative Reproductive Success", 2, cex = 1.5, line = 1.0)

#Add slopes as extra text on the plot
text(x = 5.75, y = 1.0, labels = "Slopes:", 
     adj = c(0, 0), cex = 1, font = 2)

slope_values <- paste0("S. floridae = ", round(slopes["floridae"], 3), "\n",
                       "S. fuscus = ", round(slopes["fuscus"], 3), "\n",
                       "S. scovelli = ", round(slopes["scovelli"], 3))

text(x = 5.75, y = 0.3, labels = slope_values, 
     adj = c(0, 0), cex = 1, font = 1)

outer_legend("top",
             c("S. floridae", "S. fuscus", "S. scovelli"),
             col = c("#2F97C1", "#C05746", "#FAC748"),
             lwd = 3,
             bty = 'n',
             cex = 1.5,
             pch = c(22, 21, 24),
             pt.bg = c("#2F97C175", "#C0574675", "#FAC74875"),
             lty = 1:3,
             ncol = 3,
             text.font = 3)

dev.off()

```

The Bateman gradient primarily focuses on pre-copulatory selection, to add an extra component I am going to compare the proportion of eggs developed (post-copulatory selection) between singly and multiply mated females across the species.

```{r s-m-prop-developed}
fem_fitness_all <- rbind(FL_fem_fitness[,c(2:3,12:17)], FU_fem_fitness[,c(2:3,12:17)])
fem_fitness_all <- rbind(fem_fitness_all, SS_fem_fitness[,c(1:3,7:8,6,13,15)])



fem_fitness_all$prop_developed <- ifelse(fem_fitness_all$totalEggs == 0,
                                         0,
                                         fem_fitness_all$NumDeveloped/fem_fitness_all$totalEggs)
fem_fitness_all$mating_status <- ifelse(fem_fitness_all$MatingSuccess == 0,
                                        paste0("U"),
                                        ifelse(fem_fitness_all$MatingSuccess == 1,
                                               paste0("S"),
                                               paste0("M")))

data <- fem_fitness_all[fem_fitness_all$MatingSuccess !=0,]
data$group <- interaction(data$species, data$mating_status, sep = "_")
data$group <- factor(data$group, 
                     levels = c("floridae_S", "floridae_M",
                                "fuscus_S", "fuscus_M",
                                "scovelli_S", "scovelli_M"))

mated_colors <- c("S" = "#D6D6D6", 
                  "M" = "#8C8A8A")

pdf("figs/SM_boxplot.pdf", width = 8, height=8)

par(oma=c(4,5,1,1), 
    mar=c(1,1,1,0))

boxplot(prop_developed ~ group, 
        data = data,
        col = rep(mated_colors, 3),
        frame = FALSE,
        axes = FALSE,
        ylim = c(0, 1),
        lwd = 1.5,
        outline = FALSE,
        border = "#454545")

points(jitter(as.numeric(data$group), amount = 0.15), 
       data$prop_developed,
       col = "#00000095",
       pch = 19,
       cex = 1.4)

axis(1, labels = c("",rep(c("S", "M"), 3),""),
     at = 0:7,
     lwd = 2, lwd.ticks = 2, 
     las = 1, cex.axis = 1.25)

axis(2, labels = seq(-1, 1, 0.2),
     at = seq(-1, 1, 0.2), 
     lwd = 2,
     ylim = c(0, 1),
     cex.axis = 1.5,
     las = 2)

mtext("S. floridae", side = 1, line = 2.5, at = 1.5, cex = 1.5, font = 3)
mtext("S. fuscus", side = 1, line = 2.5, at = 3.5, cex = 1.5, font = 3)
mtext("S. scovelli", side = 1, line = 2.5, at = 5.5, cex = 1.5, font = 3)

mtext("Proportion Eggs Developed",side = 2, cex = 1.5, outer = TRUE, line = 2.25)

# Add legend
par(fig = c(0, 1, 0, 1), oma = c(5, 5, 5, 0),
    mar = c(3, 1, 2, 1), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")

legend("bottomright", 
       legend = c("Single Mating",
                  "Mutiple Matings"),
       pt.bg=mated_colors,
       pch=22, ncol=1, cex=1.25,
       y.intersp = 1.5, pt.cex=2,
       border = NA, bty = "n", xpd = TRUE)



dev.off()


```

We can test to see if there are any significant differences as well.

```{r}
data$eggs_per_mate <- data$totalEggs/data$MatingSuccess
t.test(data$prop_developed[data$species == "floridae"] ~ data$mating_status[data$species == "floridae"],
       var.equal = FALSE)

t.test(data$prop_developed[data$species == "fuscus"] ~ data$mating_status[data$species == "fuscus"],
       var.equal = FALSE)

t.test(data$prop_developed[data$species == "scovelli"] ~ data$mating_status[data$species == "scovelli"],
       var.equal = FALSE)

t.test(data$eggs_per_mate[data$species == "floridae"] ~ data$mating_status[data$species == "floridae"],
       var.equal = FALSE)

t.test(data$eggs_per_mate[data$species == "fuscus"] ~ data$mating_status[data$species == "fuscus"],
       var.equal = FALSE)

t.test(data$eggs_per_mate[data$species == "scovelli"] ~ data$mating_status[data$species == "scovelli"],
       var.equal = FALSE)

```

The only significant difference present is in _S. scovelli_. For the other two species, even if there were a significant difference, it is likely that the sample size of the multiply mated females is too small to detect one.

```{r}
figB <- image_ggplot(image_read_pdf('figs/SM_boxplot.pdf'),interpolate = TRUE)
figA <- image_ggplot(image_read_pdf('figs/fem_bateman.pdf'),interpolate = TRUE)

fig <- figA + figB + plot_annotation(tag_levels = "A")

ggsave("figs/Fig_bateman_prop.pdf", fig, height=5, width=10)
ggsave("figs/Fig_bateman_prop.png", fig, height=5, width=10) # also save as a png
```

